name: Getting statistics on repo

on:
  workflow_dispatch:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron: '30 14 * * *'

jobs:
  pr-statistics:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: write
    steps:
      - uses: actions/checkout@v3
      - name: Getting open PRs count and put to measurements
        shell: bash
        run: |
          GITHUB_PRS_RESPONSE=$(curl -s \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                https://api.github.com/repos/Kotlin/kotlinx.serialization/pulls\?state\=open\&per_page\=100)
#          TODO replace URL with https://api.github.com/repos/${{ github.repository }}/pulls
          
          GITHUB_PR_COUNT=$(echo "$GITHUB_PRS_RESPONSE" | jq '. | length')
          TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
          echo "pull_requests,$GITHUB_PR_COUNT,$TIMESTAMP" >> statistics/measurements.csv
      - name: Commit report
        run: |
          git config --global user.name 'GitHub Automation'
          git config --global user.email 'github-automation@users.noreply.github.com'
          git commit -am "Updating measurements"
          git push